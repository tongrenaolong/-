<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜å•é¡µé¢</title>
    <!-- å¼•å…¥ Bootstrap æ ·å¼ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f7f7f7;
        }

        .navbar {
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            background-color: #ffffff;
            box-shadow: 1px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 100vh;
        }

        .sidebar h5 {
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            margin-top: 50px;
            color: #aaa;
        }

        .empty-state h3 {
            font-weight: 300;
        }

        .empty-state button {
            margin-top: 20px;
        }
        /* ä¿è¯æœç´¢æ¡†å’ŒæŒ‰é’®å¯¹é½ */
        #search-input {
            width: 150px;
        }

        h5 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #add-list-btn {
            margin-left: 10px;
        }


    </style>
</head>
<body>
<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">åŠ›æ‰£</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="#">å­¦ä¹ </a></li>
                <li class="nav-item"><a class="nav-link" href="#">é¢˜åº“</a></li>
                <li class="nav-item"><a class="nav-link" href="#">ç«èµ›</a></li>
                <li class="nav-item"><a class="nav-link" href="#">è®¨è®º</a></li>
                <li class="nav-item"><a class="nav-link" href="#">æ±‚èŒ</a></li>
                <li class="nav-item"><a class="nav-link" href="#">å•†åº—</a></li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="#">ğŸ””</a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="account-link">{{ account }}</a></li>
                <li class="nav-item"><a class="btn btn-warning btn-sm" href="#">Plus ä¼šå‘˜</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- å·¦ä¾§ä¾§è¾¹æ  -->
        <aside class="col-md-3 sidebar">
            <h5>
                æˆ‘çš„é¢˜å•
            </h5>
            <div class="d-flex justify-content-between align-items-center">
                <!-- æœç´¢æ¡†æ”¾åœ¨åˆ›å»ºé¢˜å•æŒ‰é’®çš„å·¦ä¾§ -->
                <div class="input-group me-2" style="flex-grow: 1;">
                    <input type="text" id="search-input" class="form-control form-control-sm" placeholder="è¯·è¾“å…¥é¢˜å•åç§°" aria-label="æœç´¢é¢˜å•">
                </div>
                <button class="btn btn-sm btn-success" id="add-list-btn" title="åˆ›å»ºé¢˜å•">+</button>
            </div>
            <ul class="list-group" id="set-list">
                <!-- é¢˜å•åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åœ¨è¿™é‡Œ -->
            </ul>
        </aside>
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="col-md-9">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">é¢˜ç›®åˆ—è¡¨</h5>
                </div>
            </div>

            <!-- ç©ºé¢˜ç›®çŠ¶æ€ -->
            <div class="empty-state" id="empty-state">
                <h3>æš‚æ— é¢˜ç›®</h3>
            </div>
        </main>
    </div>
</div>

<!-- é¢˜å•åˆ—è¡¨æ¨¡æ€æ¡† -->
<div class="modal fade" id="searchResultModal" tabindex="-1" aria-labelledby="searchResultModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="searchResultModalLabel">é¢˜å•æœç´¢ç»“æœ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table">
          <thead>
            <tr>
<!--              <th><input type="checkbox" id="select-all"></th>-->
              <th>æ˜¯å¦åŠ å…¥</th>
              <th>é¢˜å•åç§°</th>
              <th>åˆ›å»ºè€…</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æè¿°</th>
              <th>é¢˜ç›®æ€»é‡</th>
              <th>åŠ å…¥äººæ•°</th>
            </tr>
          </thead>
          <tbody id="search-results">
            <!-- æœç´¢ç»“æœå°†åŠ¨æ€æ’å…¥è¿™é‡Œ -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-primary" id="confirm-selection">åŠ å…¥åˆ·é¢˜</button>
      </div>
    </div>
  </div>
</div>

<!-- åˆ›å»ºé¢˜å• Modal -->
<div class="modal fade" id="createQuizModal" tabindex="-1" aria-labelledby="createQuizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createQuizModalLabel">åˆ›å»ºæ–°é¢˜å•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="quiz-title" class="form-label">é¢˜å•æ ‡é¢˜</label>
                    <input type="text" class="form-control" id="quiz-title" placeholder="è¯·è¾“å…¥é¢˜å•æ ‡é¢˜">
                </div>

                <!-- é¢˜å•æè¿° -->
                <div class="mb-3">
                    <label for="quiz-description" class="form-label">é¢˜å•æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-control" id="quiz-description" rows="3"
                              placeholder="è¯·è¾“å…¥é¢˜å•æè¿°"></textarea>
                </div>

                <!-- é¢˜ç›®è¡¨æ ¼ -->
                <table class="table table-bordered" id="quiz-table">
                    <thead>
                    <tr>
                        <th>é¢˜ç›®åç§°</th>
                        <th>é¢˜ç›®é“¾æ¥</th>
                        <th>éš¾åº¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                        <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                        <td>
                            <select class="form-control">
                                <option value="easy">ç®€å•</option>
                                <option value="medium">ä¸­ç­‰</option>
                                <option value="hard">å›°éš¾</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm remove-row-btn">åˆ é™¤</button>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <button type="button" class="btn btn-success" id="add-row-btn">+ æ·»åŠ é¢˜ç›®</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" id="create-quiz-btn">åˆ›å»ºé¢˜å•</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createProblemModal" tabindex="-1" aria-labelledby="createQuizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createQuizModalLabel">åˆ›å»ºé¢˜ç›®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- é¢˜ç›®è¡¨æ ¼ -->
                <table class="table table-bordered" id="problems-table">
                    <thead>
                    <tr>
                        <th>é¢˜ç›®åç§°</th>
                        <th>é¢˜ç›®é“¾æ¥</th>
                        <th>éš¾åº¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                        <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                        <td>
                            <select class="form-control">
                                <option value="easy">ç®€å•</option>
                                <option value="medium">ä¸­ç­‰</option>
                                <option value="hard">å›°éš¾</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm remove-row-btn">åˆ é™¤</button>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <button type="button" class="btn btn-success" id="add-row-btn">+ æ·»åŠ é¢˜ç›®</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" id="create-problem-btn">åˆ›å»ºé¢˜ç›®</button>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap å’Œ JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function clearSearchInput(){
        const search_input = document.getElementById('search-input');
        search_input.innerHTML = '';
    }
    // ç›‘å¬æœç´¢æ¡†å›è½¦äº‹ä»¶
    document.getElementById('search-input').addEventListener('keydown', async function(event) {
        if (event.key === 'Enter') {  // å¦‚æœæŒ‰ä¸‹çš„æ˜¯å›è½¦é”®
            event.preventDefault(); // é˜²æ­¢é¡µé¢åˆ·æ–°æˆ–è¡¨å•æäº¤
            const set_name = event.target.value.trim();
            // console.log('set_name: ',set_name)
            if (set_name) {
                try {
                    const encode_set_name = encodeURIComponent(set_name)
                    // å‘èµ·è¯·æ±‚åˆ°åç«¯ï¼Œè·å–æœç´¢ç»“æœ
                    const response = await fetch(`/search_problem_sets?set_name=${encode_set_name}`);
                    const data = await response.json();
                    clearSearchInput();

                    if (data['status_code'] ) {
                        // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœ
                        const tbody = document.getElementById('search-results');
                        tbody.innerHTML = '';// æ¸…ç©ºæ‰€æœ‰å†…å®¹
                        if( data['set_data_list'].length > 0){
                            // æ˜¾ç¤ºæ–°çš„æœç´¢ç»“æœ
                            data['set_data_list'].forEach(set => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td><input type="checkbox" class="set-checkbox" data-set-id="${set['set_id']}"></td>
                                    <td>${set['set_name']}</td>
                                    <td>${set['account']}</td>
                                    <td>${set['created_at']}</td>
                                    <td>${set['description']}</td>
                                    <td>${set['total_problems']}</td>
                                    <td>${set['members_count']}</td>
                                `;
                                tbody.appendChild(row);
                            });
                        }else{
                            tbody.innerHTML = `<tr>
            <th colspan="7" style="text-align: center;">æ²¡æœ‰å¯ä»¥åŠ å…¥çš„é¢˜é›†</th>
        </tr>`;
                        }

                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        const searchResultModal = new bootstrap.Modal(document.getElementById('searchResultModal'));
                        searchResultModal.show();
                    } else {
                        alert('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                }
            }
        }
    });

    // ç›‘å¬æ¨¡æ€æ¡†ä¸­çš„â€œç¡®è®¤â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    // document.getElementById('confirm-selection').addEventListener('click', function() {
    //     const selectedSets = [];
    //     // const checkboxes = document.querySelectorAll('.set-checkbox');
    //     // checkboxes.forEach((checkbox)=>{
    //     //     if(checkbox.checked){
    //     //         selectedSets.push(checkbox.dataset.setId)
    //     //     }
    //     // });
    //     document.querySelectorAll('.set-checkbox:checked').forEach(checkbox => {
    //         selectedSets.push(checkbox.dataset.setId);
    //     });
    //     console.log('selectedSets: ',selectedSets)
    //     if (selectedSets.length > 0) {
    //         console.log('å·²é€‰æ‹©çš„é¢˜å•IDï¼š', selectedSets);
    //         // åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œåç»­å¤„ç†ï¼Œå¦‚å°†é€‰ä¸­çš„é¢˜å•IDå‘é€åˆ°åç«¯
    //         fetch(`/join_problem_set`,{
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json'
    //             },
    //             body: JSON.stringify({
    //                 'set_id_list':selectedSets,
    //             })
    //         }).then(response => response.json())  // è§£æå“åº”ä¸º JSON
    //             .then(data=>{
    //                 if(data['status_code']){
    //                     console.log('åŠ å…¥æˆåŠŸ')
    //                     getSets()
    //                 }
    //             }).catch(err=>{
    //                 console.error(err)
    //         })
    //     } else {
    //         // alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªé¢˜å•');
    //         console.log('æ²¡æœ‰é€‰æ‹©è¦åŠ å…¥çš„é¢˜å•')
    //     }
    //
    //     // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç©ºæ•°æ®
    //     const searchResultModal = bootstrap.Modal.getInstance(document.getElementById('searchResultModal'));
    //     searchResultModal.hide();
    //
    //     // æ¸…ç©ºæœç´¢æ¡†å’Œæœç´¢ç»“æœ
    //     document.getElementById('search-input').value = '';
    //     document.getElementById('search-results').innerHTML = '';
    // });

    // ç›‘å¬æ¨¡æ€æ¡†ä¸­çš„â€œç¡®è®¤â€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.getElementById('confirm-selection').addEventListener('click', async function() {
    const selectedSets = [];

    // è·å–é€‰ä¸­çš„å¤é€‰æ¡†çš„ data-set-id
    document.querySelectorAll('.set-checkbox:checked').forEach(checkbox => {
        selectedSets.push(checkbox.dataset.setId);
    });

    console.log('selectedSets: ', selectedSets);

    if (selectedSets.length > 0) {
        console.log('å·²é€‰æ‹©çš„é¢˜å•IDï¼š', selectedSets);

        // å¼‚æ­¥å‘é€è¯·æ±‚åˆ°åç«¯
        try {
            const response = await fetch('/join_problem_set', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'set_id_list': selectedSets,
                }),
            });

            const data = await response.json();  // è§£æå“åº”ä¸º JSON

            // å¤„ç†åç«¯è¿”å›çš„æ•°æ®
            console.log(data);

            // æ ¹æ®è¿”å›çš„æ•°æ®åšç›¸åº”çš„å¤„ç†
            if (data['status_code']) {
                // åˆ·æ–°é¢˜å•æ•°æ®
                getSets();
                console.log('é¢˜å•åŠ å…¥æˆåŠŸ');
            } else {
                alert('åŠ å…¥é¢˜å•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }

        } catch (err) {
            console.error(err);
            alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        }

    } else {
        console.log('æ²¡æœ‰é€‰æ‹©è¦åŠ å…¥çš„é¢˜å•');
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªé¢˜å•');
    }

    // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç©ºæ•°æ®
    const searchResultModal = bootstrap.Modal.getInstance(document.getElementById('searchResultModal'));
    searchResultModal.hide();

    // æ¸…ç©ºæœç´¢æ¡†å’Œæœç´¢ç»“æœ
    document.getElementById('search-input').value = '';
    document.getElementById('search-results').innerHTML = '';
});

    var current_set_id = -1;
    // document.addEventListener('DOMContentLoaded', async () => {
    //     getSets();
    //     // <li className="nav-item"><a className="nav-link" href="#">{{account}}</a></li>
    //     const response = await fetch('/get_user_info',{
    //         method:'GET',
    //     });
    //     const responseData = response.json();
    //     if(responseData['status_code']){
    //         document.getElementById('account-link').textContent = responseData['user_info']['account'];
    //     }else{
    //         console.log('ç”¨æˆ·è·å–å¤±è´¥');
    //     }
    // });
        document.addEventListener('DOMContentLoaded', () => {
        getSets();

    });

    async function getSets() {
        try {
            // å‘é€è¯·æ±‚åˆ°åç«¯
            const response = await fetch('/get_sets', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            // if (!response.ok) {
            //     throw new Error('é¢˜å•è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            // }
            // å¤„ç†æˆåŠŸå“åº”
            const responseData = await response.json();
            if (responseData['status_code']) {
                const sets = responseData['sets'];
                const setList = document.getElementById('set-list');
                setList.innerHTML = '';
                // éå†é¢˜å•æ•°æ®å¹¶æ·»åŠ åˆ°åˆ—è¡¨
                sets.forEach(set => {
                    console.log(set)
                    const [set_id, set_name, created_at, description, authority] = set;

                    // åˆ›å»ºæ–°çš„åˆ—è¡¨é¡¹
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                    // è®¾ç½®åˆ—è¡¨é¡¹çš„å†…å®¹
                    listItem.innerHTML = `
                                <div>
                                    <strong>${set_name}</strong>
                                    <p class="text-muted mb-0">${description}</p>
                                    <small>åˆ›å»ºæ—¶é—´: ${created_at}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadSet('${set_id}')">æŸ¥çœ‹</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="deleteSet('${set_id}')">åˆ é™¤</button>
                            `;

                    // æ·»åŠ åˆ°åˆ—è¡¨
                    setList.appendChild(listItem);
                });

                // alert("é¢˜å•è·å–æˆåŠŸï¼");
            } else {
                alert("é¢˜å•è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            }

        } catch (error) {
            console.error('Error:', error);
            alert("é¢˜å•è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const addListBtn = document.getElementById('add-list-btn');
        if (addListBtn) {
            addListBtn.addEventListener('click', function () {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const createQuizModal = new bootstrap.Modal(document.getElementById("createQuizModal"));
                createQuizModal.show();
            });
        }

        // ç»‘å®šæ·»åŠ è¡ŒæŒ‰é’®
        document.getElementById("add-row-btn").addEventListener("click", () => {
            const tableBody = document.querySelector("#quiz-table tbody");
            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                    <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                    <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                    <td>
                        <select class="form-control">
                            <option value="easy">ç®€å•</option>
                            <option value="medium">ä¸­ç­‰</option>
                            <option value="hard">å›°éš¾</option>
                        </select>
                    </td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">åˆ é™¤</button></td>
                `;
            tableBody.appendChild(newRow);

            // ç»‘å®šæ–°è¡Œçš„åˆ é™¤æŒ‰é’®
            newRow.querySelector(".remove-row-btn").addEventListener("click", () => {
                tableBody.removeChild(newRow);
            });
        });

        // åˆ›å»ºé¢˜å•
        document.getElementById("create-quiz-btn").addEventListener("click", async () => {
            const title = document.getElementById("quiz-title").value.trim();
            const description = document.getElementById("quiz-description").value.trim(); // è·å–é¢˜å•æè¿°
            if (!title) {
                alert("é¢˜å•æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }

            const tableRows = document.querySelectorAll("#quiz-table tbody tr");
            const questions = [];

            // å¦‚æœè¡¨æ ¼æœ‰é¢˜ç›®ï¼Œåˆ™æ”¶é›†é¢˜ç›®ä¿¡æ¯
            tableRows.forEach(row => {
                const name = row.querySelector("td:nth-child(1) input").value.trim();
                const link = row.querySelector("td:nth-child(2) input").value.trim();
                const difficulty = row.querySelector("td:nth-child(3) select").value;

                if (name && link && difficulty) {
                    questions.push({name, link, difficulty});
                }
            });

            // å³ä½¿æ²¡æœ‰é¢˜ç›®ä¹Ÿå…è®¸åˆ›å»ºé¢˜å•
            const quizData = {
                title: title, // åç«¯çš„å­—æ®µæ˜¯ set_nameï¼Œåç»­å¯ä»¥è¿›è¡Œä¿®æ”¹
                description: description, // æ·»åŠ æè¿°å­—æ®µ
                questions: questions // å¦‚æœæ²¡æœ‰é¢˜ç›®ï¼Œè¿™é‡Œå°†ä¸ºç©ºæ•°ç»„
            };

            try {
                // å‘é€è¯·æ±‚åˆ°åç«¯
                const response = await fetch('/create_set', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quizData)
                });

                // å¤„ç†æˆåŠŸå“åº”
                const responseData = await response.json();
                if (responseData['status_code']) {
                    alert("é¢˜å•åˆ›å»ºæˆåŠŸï¼");
                    // å…³é—­æ¨¡æ€æ¡†
                    const createQuizModal = bootstrap.Modal.getInstance(document.getElementById("createQuizModal"));
                    createQuizModal.hide();

                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById("quiz-title").value = "";
                    document.getElementById("quiz-description").value = ""; // æ¸…ç©ºæè¿°
                    document.querySelector("#quiz-table tbody").innerHTML = `
                            <tr>
                                <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                                <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                                <td>
                                    <select class="form-control">
                                        <option value="easy">ç®€å•</option>
                                        <option value="medium">ä¸­ç­‰</option>
                                        <option value="hard">å›°éš¾</option>
                                    </select>
                                </td>
                                <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">åˆ é™¤</button></td>
                            </tr>
                        `;
                    getSets();
                } else {
                    alert("é¢˜å•åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
                }

            } catch (error) {
                console.error('Error:', error);
                alert("é¢˜å•åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            }
        });
    });
    document.addEventListener('DOMContentLoaded', () => {
        // è·å–é¡µé¢ä¸Šçš„æ‰€æœ‰æ¨¡æ€æ¡†
        const modals = document.querySelectorAll('.modal');

        // éå†æ‰€æœ‰æ¨¡æ€æ¡†
        modals.forEach(modal => {
            // ç›‘å¬æ¯ä¸ªæ¨¡æ€æ¡†çš„ 'hidden.bs.modal' äº‹ä»¶
            modal.addEventListener('hidden.bs.modal', () => {
                // åªå¯¹ç‰¹å®šæ¨¡æ€æ¡†è¿›è¡Œå†…å®¹æ¸…ç©º
                if (modal.id === "createQuizModal") {
                    // æ¸…ç©ºåˆ›å»ºé¢˜å•çš„æ¨¡æ€æ¡†å†…å®¹
                    document.getElementById("quiz-title").value = "";
                    document.getElementById("quiz-description").value = "";
                    document.querySelector("#quiz-table tbody").innerHTML = `
                    <tr>
                        <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                        <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                        <td>
                            <select class="form-control">
                                <option value="easy">ç®€å•</option>
                                <option value="medium">ä¸­ç­‰</option>
                                <option value="hard">å›°éš¾</option>
                            </select>
                        </td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">åˆ é™¤</button></td>
                    </tr>
                `;
                }

                if (modal.id === "createProblemModal") {
                    // æ¸…ç©ºåˆ›å»ºé¢˜ç›®çš„æ¨¡æ€æ¡†å†…å®¹
                    document.querySelector("#problems-table tbody").innerHTML = `
                    <tr>
                        <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                        <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                        <td>
                            <select class="form-control">
                                <option value="easy">ç®€å•</option>
                                <option value="medium">ä¸­ç­‰</option>
                                <option value="hard">å›°éš¾</option>
                            </select>
                        </td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">åˆ é™¤</button></td>
                    </tr>
                `;
                }
            });
        });
    });

    function clearMain() {
        const mainContent = document.querySelector('main');
        mainContent.innerHTML = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">é¢˜ç›®åˆ—è¡¨</h5>
                        <p class="text-muted">æš‚æ— é¢˜ç›®</p>
                    </div>
                </div>
            `;
    }

    async function deleteSet(set_id) {
        try {
            const response = await fetch(`/delete_set_id?set_id=${set_id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            const responseData = await response.json();
            console.log('responseData: ',responseData);
            if (responseData['status_code']) {
                if (set_id === current_set_id) {
                    current_set_id = -1;
                    clearMain();
                }else{
                    getSets();
                }
            }else{
                alert(responseData['message'])
            }
        } catch (error) {
            alert(error)
        }
    }

    async function loadSet(set_id) {
        try {
            current_set_id = set_id
            // è¯·æ±‚é¢˜å•è¯¦æƒ…
            const response = await fetch(`/get_set_problems?set_id=${set_id}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            const responseData = await response.json();
            if (responseData['status_code']) {
                const problems_info_list = responseData['problems_info_list'];

                // è·å–ä¸»é¡µé¢åŒºåŸŸ
                const mainContent = document.querySelector('main');

                // æ¸…ç©ºä¸»é¡µé¢å†…å®¹å¹¶æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
                mainContent.innerHTML = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                        é¢˜ç›®åˆ—è¡¨
                        </h5>
            `;

                // å¦‚æœé—®é¢˜åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºâ€œæš‚æ— é¢˜ç›®â€
                if (problems_info_list.length === 0 || problems_info_list.every(list => list.length === 0)) {
                    mainContent.innerHTML += `
                    <p class="text-muted">æš‚æ— é¢˜ç›®</p>
                `;
                } else {
                    // å¦åˆ™æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
                    mainContent.innerHTML += `
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>æ˜¯å¦å®Œæˆ</th>
                                <th>é¢˜ç›®åç§°</th>
                                <th>éš¾åº¦</th>
                                <th>å®Œæˆæƒ…å†µ</th>
                                <th>æ‰“å¡ä¸Šä¼ </th>
                            </tr>
                        </thead>
                        <tbody id="question-list">
                            ${problems_info_list.map(
                        (problem) => {
                            // var completion_rate = problem.completion_rate || 0; // è·å–é¢˜ç›®çš„å®Œæˆæƒ…å†µï¼Œé»˜è®¤ä¸º0

                            var completion_rate = problem.completed / problem.all
                            const percentage = Math.round(completion_rate * 100); // å°†å°æ•°è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                            return `
                                    <tr>
                                        <td><input type="checkbox" ${problem.status === 'completed' ? 'checked' : ''} class="form-check-input" disabled></td>
                                        <td><a href="${problem.link}" target="_blank">${problem.problem_name}</a></td>
                                        <td>${problem.difficulty}</td>
                                        <td>
                                            <!-- æ˜¾ç¤ºè¿›åº¦æ¡å’Œç™¾åˆ†æ¯” -->
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar bg-info text-dark" style="width: ${percentage}%" role="progressbar"
                                                     aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                                                     ${percentage}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                        <!-- æ‰“å¡ä¸Šä¼ åˆ—å¢åŠ ä¸€ä¸ªâ€œæ‰“å¼€â€æŒ‰é’® -->
                                            <button class="btn btn-primary btn-sm open-upload-btn" data-problem-id="${problem.problem_id}" data-problem-name="${problem.problem_name}">æ‰“å¡</button>
                                        </td>
                                    </tr>
                                `
                        }
                    ).join('')}
                        </tbody>
                    </table>
                    <div class="text-center">
                        <button class="btn btn-dark btn-lg" id="add-question-btn2" style="width: 100%;">+ æ·»åŠ é¢˜ç›®</button>
                    </div>
                `;
                }

                mainContent.innerHTML += `</div></div>`;
                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ç»™åŠ¨æ€æ¸²æŸ“çš„æŒ‰é’®
                const addQuestionBtn = document.getElementById('add-question-btn2');
                if (addQuestionBtn) {
                    addQuestionBtn.addEventListener('click', function () {
                        // å¼¹å‡ºé¡µé¢
                        console.log('æ·»åŠ é¢˜ç›®æŒ‰é’®è¢«ç‚¹å‡»');
                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        const createProblemModal = new bootstrap.Modal(document.getElementById("createProblemModal"));
                        createProblemModal.show();

                        // ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¼¹å‡ºé¡µé¢çš„é€»è¾‘ï¼Œæ¯”å¦‚æ˜¾ç¤ºä¸€ä¸ªå¼¹å‡ºæ¡†
                        document.getElementById("createProblemModal").querySelector("#add-row-btn").addEventListener("click", () => {
                            const tableBody = document.querySelector("#problems-table tbody");
                            const newRow = document.createElement("tr");
                            newRow.innerHTML = `
                    <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                    <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                    <td>
                        <select class="form-control">
                            <option value="easy">ç®€å•</option>
                            <option value="medium">ä¸­ç­‰</option>
                            <option value="hard">å›°éš¾</option>
                        </select>
                    </td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-problem-row-btn">åˆ é™¤</button></td>
                `;
                            tableBody.appendChild(newRow);

                            // ç»‘å®šæ–°è¡Œçš„åˆ é™¤æŒ‰é’®
                            newRow.querySelector(".remove-problem-row-btn").addEventListener("click", () => {
                                tableBody.removeChild(newRow);
                            });
                        });
                    });
                }


                // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ç»™åŠ¨æ€æ¸²æŸ“çš„æŒ‰é’®
                const openUploadBtns = document.querySelectorAll('.open-upload-btn');
                openUploadBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const problem_id = btn.getAttribute('data-problem-id');
                        const problem_name = btn.getAttribute('data-problem-name');
                        openUploadModal(problem_id, problem_name);  // æ‰“å¼€ä¸Šä¼ é¡µé¢æ¨¡æ€æ¡†
                    });
                });

            } else {
                alert("é¢˜ç›®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            }
        } catch (error) {
            console.error('Error:', error);
            alert("é¢˜ç›®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
        }
    }

    function openUploadModal(problemId, problemName) {
        const modalHtml = `
        <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadModalLabel">é¢˜ç›®: ${problemName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="upload-form">
                            <div class="mb-3">
                                <label for="input-text" class="form-label">è¾“å…¥å†…å®¹</label>
                                <textarea id="input-text" class="form-control" rows="4" placeholder="è¯·è¾“å…¥ç›¸å…³å†…å®¹"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="file-upload" class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
                                <input type="file" id="file-upload" class="form-control" accept="image/*">
                            </div>
                            <div class="text-center">
                                <button type="button" class="btn btn-primary" id="status-submit">ä¸Šä¼ </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
        uploadModal.show();
        const uploadModalElement  = document.getElementById('uploadModal');
    // ç›‘å¬æ¨¡æ€æ¡†å…³é—­äº‹ä»¶ï¼Œæ¸…ç©ºè¡¨å•å†…å®¹
    uploadModalElement.addEventListener('hidden.bs.modal', function () {
        // æ¸…ç©ºè¡¨å•
        const form = document.getElementById('upload-form');
        form.reset(); // æ¸…ç©ºè¡¨å•å†…å®¹

        // å…³é—­æ¨¡æ€æ¡†æ—¶ç§»é™¤æ¨¡æ€æ¡†HTML
        uploadModal.remove();
    });

    // å°†å›¾ç‰‡è½¬æ¢ä¸º Base64 æ ¼å¼
    function encodeImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                resolve(event.target.result);  // è¿”å› Base64 å­—ç¬¦ä¸²
            };
            reader.onerror = function(error) {
                reject('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            reader.readAsDataURL(file);  // è½¬æ¢ä¸º Base64
        });
    }

    // å›¾ç‰‡å‹ç¼©å‡½æ•°
    function compressImage(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = new Image();
            img.src = e.target.result;

            img.onload = function () {
                // ä½¿ç”¨Canvasè¿›è¡Œå›¾ç‰‡å‹ç¼©
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 800;

                // è·å–åŸå§‹å›¾ç‰‡çš„å®½é«˜
                let width = img.width;
                let height = img.height;

                // æ ¹æ®æœ€å¤§å®½é«˜ï¼Œè®¡ç®—å‹ç¼©æ¯”ä¾‹
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height = Math.round(height * (MAX_WIDTH / width));
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width = Math.round(width * (MAX_HEIGHT / height));
                        height = MAX_HEIGHT;
                    }
                }

                // è®¾å®šCanvaså°ºå¯¸
                canvas.width = width;
                canvas.height = height;

                // ç»˜åˆ¶å›¾ç‰‡åˆ°Canvasä¸Šå¹¶è¿›è¡Œå‹ç¼©
                ctx.drawImage(img, 0, 0, width, height);

                // å°†å‹ç¼©åçš„å›¾ç‰‡è½¬ä¸ºBlob
                canvas.toBlob(function (blob) {
                    resolve(new File([blob], file.name, {type: file.type}));
                }, file.type, 0.7); // 0.7æ˜¯å‹ç¼©è´¨é‡ï¼ˆ0.0 ~ 1.0ï¼‰
            };

            img.onerror = function () {
                reject('å›¾ç‰‡åŠ è½½å¤±è´¥');
            };
        };

        reader.onerror = function () {
            reject('æ–‡ä»¶è¯»å–å¤±è´¥');
        };

        reader.readAsDataURL(file);
    });
}

    // å¤„ç†æ‰“å¡è¡¨å•çš„æäº¤
    document.getElementById('status-submit').addEventListener('click', async function (e) {
    e.preventDefault();
    console.log('Submit handled and prevented!');

    const inputText = document.getElementById('input-text').value;
    const fileInput = document.getElementById('file-upload');
    const file = fileInput.files[0];
    if (!inputText || !file) {
        alert("è¯·è¾“å…¥å†…å®¹å¹¶é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡");
        return;
    }

    // è¯»å–æ–‡ä»¶å¹¶è¿›è¡Œå‹ç¼©
    const compressedFile = await compressImage(file);
    if (!compressedFile) {
        alert("å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
        return;
    }

    // å°†å‹ç¼©åçš„æ–‡ä»¶è½¬æ¢ä¸º Base64 ç¼–ç 
    const base64Image = await encodeImageToBase64(compressedFile);

    // åˆ›å»º FormData å¯¹è±¡
    const formData = new FormData();
    formData.append('problem_id', problemId);
    formData.append('input_text', inputText);
    formData.append('image_data', base64Image);  // ä¼ é€’ Base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®
    formData.append('status', 'completed');

    try {
        const response = await fetch('/upload_solution', {
            method: 'POST',
            body: formData,
        });
        const data = await response.json();
        console.log(data)
        if (data['status_code']) {
            alert('ä¸Šä¼ æˆåŠŸ');
            uploadModal.hide();
        } else {
            alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
    console.log(current_set_id);
    loadSet(current_set_id);
});

    }

    document.getElementById('create-problem-btn').addEventListener('click', async () => {
        const tableRows = document.querySelectorAll("#problems-table tbody tr");
        const questions = [];

        // å¦‚æœè¡¨æ ¼æœ‰é¢˜ç›®ï¼Œåˆ™æ”¶é›†é¢˜ç›®ä¿¡æ¯
        tableRows.forEach(row => {
            const name = row.querySelector("td:nth-child(1) input").value.trim();
            const link = row.querySelector("td:nth-child(2) input").value.trim();
            const difficulty = row.querySelector("td:nth-child(3) select").value;

            if (name && link && difficulty) {
                questions.push({name, link, difficulty});
            }
        });
        const data = {
            set_id: current_set_id,
            questions: questions // å¦‚æœæ²¡æœ‰é¢˜ç›®ï¼Œè¿™é‡Œå°†ä¸ºç©ºæ•°ç»„
        };
        try {
            // å‘é€è¯·æ±‚åˆ°åç«¯
            const response = await fetch('/create_problems', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            // å¤„ç†æˆåŠŸå“åº”
            const responseData = await response.json();
            if (responseData['status_code']) {
                // alert("é¢˜å•åˆ›å»ºæˆåŠŸï¼");
                // å…³é—­æ¨¡æ€æ¡†
                const createProblemModal = bootstrap.Modal.getInstance(document.getElementById("createProblemModal"));
                createProblemModal.hide();

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.querySelector("#problems-table tbody").innerHTML = `
                            <tr>
                                <td><input type="text" class="form-control" placeholder="é¢˜ç›®åç§°"></td>
                                <td><input type="url" class="form-control" placeholder="é¢˜ç›®é“¾æ¥"></td>
                                <td>
                                    <select class="form-control">
                                        <option value="easy">ç®€å•</option>
                                        <option value="medium">ä¸­ç­‰</option>
                                        <option value="hard">å›°éš¾</option>
                                    </select>
                                </td>
                                <td><button type="button" class="btn btn-danger btn-sm remove-problem-row-btn">åˆ é™¤</button></td>
                            </tr>
                        `;
                loadSet(current_set_id);
            } else {
                alert(responseData['message']);
            }
        } catch (error) {
            console.error('Error:', error);
            alert("é¢˜ç›®åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
        }
    });
</script>
</body>
</html>
